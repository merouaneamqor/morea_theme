{%- assign is_color = false -%}
{%- assign is_size = false -%}
{%- assign color_swatch_drop = option_drop -%}
{%- assign color_option_index = 0 -%}

{%- if settings.product_color_swatches -%}
  {%- for option in product.options_with_values -%}
    {%- if option == color_swatch_drop -%}
      {%- assign color_option_index = forloop.index0 -%}
      {%- assign downcased_option = color_swatch_drop.name | downcase -%}
      {%- if downcased_option contains 'color'
        or downcased_option contains 'colour'
        or downcased_option contains 'couleur'
      -%}
        {%- assign is_color = true -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- assign downcased_option_name = option_drop.name | downcase -%}
{%- if downcased_option_name contains 'size'
  or downcased_option_name contains 'taille'
  or downcased_option_name contains 'tailles'
-%}
  {%- assign is_size = true -%}
{%- endif -%}

<div class="variant-wrapper variant-wrapper--{{ settings.variant_type }} js">
  <label
    class="variant__label{% if option.name == 'Default' or option.name == 'Title' %} hidden-label{% endif %}{% unless settings.variant_labels_enable %} hidden-label{% endunless %}"
    for="ProductSelect-{{ section_id }}-option-{{ forloop.index0 }}"
  >
    {{ option.name }}

    {%- if is_color -%}
      <span class="variant__label-info">
        &mdash;
        <span
          id="VariantColorLabel-{{ section_id }}-{{ forloop.index0 }}"
          data-option-index="{{ color_option_index }}"
        >
          {{ option.selected_value }}
        </span>
      </span>
    {%- endif -%}
  </label>

  {%- assign option_index = forloop.index -%}

  <fieldset
    class="variant-input-wrap"
    name="{{ option.name }}"
    data-index="option{{ option_index }}"
    id="ProductSelect-{{ section_id }}-option-{{ forloop.index0 }}"
  >
    {%- for value in option.values -%}
      {%- assign product_available = true -%}
      {%- if product.options.size == 1 -%}
        {%- assign product_available = product.variants[forloop.index0].available -%}
      {%- endif -%}

      <div
        class="variant-input"
        data-index="option{{ option_index }}"
        data-value="{{ value | escape }}"
      >
        <input
          type="radio"
          {% if option.selected_value == value %}checked="checked"{% endif %}
          value="{{ value | escape }}"
          name="{{ option.name }}"
          data-index="option{{ option_index }}"
          class="variant__input-{{ section_id }}{% unless product_available %} disabled{% endunless %}{% if is_color %} variant__input--color-swatch-{{ section_id }}{% endif %}"
          {% if is_color %}data-color-name="{{ value | escape }}"{% endif %}
          {% if is_color %}data-color-index="{{ color_option_index }}"{% endif %}
          id="ProductSelect-{{ section_id }}-option-{{ option.name | handleize }}-{{ value | url_encode }}"
        >

        {%- if is_color -%}
{%- comment -%} Try to get hex color from variant metafields first {%- endcomment -%}
{%- assign color_hex = null -%}
{%- assign normalized_value = value | strip | downcase -%}

{%- comment -%} Find a variant with this color value and check for hex color metafield {%- endcomment -%}
{%- for variant in product.variants -%}
  {%- assign variant_color_value = variant.options[color_option_index] | strip | downcase -%}
  {%- if variant_color_value == normalized_value -%}
    {%- comment -%} Check common metafield namespaces and keys for hex color {%- endcomment -%}
    {%- if variant.metafields.custom.color_hex != blank -%}
      {%- assign color_hex = variant.metafields.custom.color_hex -%}
      {%- break -%}
    {%- elsif variant.metafields.custom.hex_color != blank -%}
      {%- assign color_hex = variant.metafields.custom.hex_color -%}
      {%- break -%}
    {%- elsif variant.metafields.custom.color != blank -%}
      {%- assign color_hex = variant.metafields.custom.color -%}
      {%- break -%}
    {%- elsif variant.metafields.my_fields.color_hex != blank -%}
      {%- assign color_hex = variant.metafields.my_fields.color_hex -%}
      {%- break -%}
    {%- elsif variant.metafields.my_fields.hex_color != blank -%}
      {%- assign color_hex = variant.metafields.my_fields.hex_color -%}
      {%- break -%}
    {%- elsif variant.metafields.my_fields.color != blank -%}
      {%- assign color_hex = variant.metafields.my_fields.color -%}
      {%- break -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- comment -%} Fallback to hardcoded mapping if no metafield found {%- endcomment -%}
{%- if color_hex == null or color_hex == blank -%}
  {%- assign color_swatch_fallback = '#cccccc' -%}

  {%- if normalized_value contains 'noir' or normalized_value contains 'black' -%}
    {%- assign color_swatch_fallback = '#000000' -%}

  {%- elsif normalized_value contains 'blanc' or normalized_value contains 'white' -%}
    {%- assign color_swatch_fallback = '#ffffff' -%}

  {%- elsif normalized_value contains 'clair'
    or normalized_value contains 'claire'
    or normalized_value contains 'light'
  -%}
    {%- assign color_swatch_fallback = '#f3f4f6' -%}

  {%- elsif normalized_value contains 'gris'
    or normalized_value contains 'gray'
    or normalized_value contains 'grey'
  -%}
    {%- assign color_swatch_fallback = '#9e9e9e' -%}

  {%- elsif normalized_value contains 'beige' -%}
    {%- assign color_swatch_fallback = '#e8dcc5' -%}

  {%- elsif normalized_value contains 'bleu'
    or normalized_value contains 'blue'
  -%}
    {%- assign color_swatch_fallback = '#1e40af' -%}

  {%- elsif normalized_value contains 'rouge'
    or normalized_value contains 'red'
  -%}
    {%- assign color_swatch_fallback = '#dc2626' -%}

  {%- elsif normalized_value contains 'rose'
    or normalized_value contains 'pink'
  -%}
    {%- assign color_swatch_fallback = '#f782bc' -%}

  {%- elsif normalized_value contains 'vert'
    or normalized_value contains 'green'
  -%}
    {%- assign color_swatch_fallback = '#16a34a' -%}

  {%- elsif normalized_value contains 'marron'
    or normalized_value contains 'brown'
  -%}
    {%- assign color_swatch_fallback = '#7c4a2d' -%}

  {%- endif -%}
{%- else -%}
  {%- assign color_swatch_fallback = color_hex -%}
{%- endif -%}



          <label
            for="ProductSelect-{{ section_id }}-option-{{ option.name | handleize }}-{{ value | url_encode }}"
            class="variant__button-label color-swatch color-swatch--{{ value | handle }}{% unless product_available %} disabled{% endunless %}"
            style="background-color: {{ color_swatch_fallback }};"
            title="{{ value | escape }}"
          ></label>

        {%- else -%}
          <div class="variant__button-wrapper{% if is_size %} variant__button-wrapper--size{% endif %}">
            <label
              for="ProductSelect-{{ section_id }}-option-{{ option.name | handleize }}-{{ value | url_encode }}"
              class="variant__button-label{% unless product_available %} disabled unavailable{% endunless %}{% if is_size %} variant__button-label--size{% endif %}{% if option.selected_value == value %} variant__button-label--selected{% endif %}"
            >
              {{ value | escape }}
            </label>
          </div>
        {%- endif -%}
      </div>
    {%- endfor -%}
  </fieldset>
</div>
